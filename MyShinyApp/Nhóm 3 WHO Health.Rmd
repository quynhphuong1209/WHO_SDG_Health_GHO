---
title: "B√ÅO C√ÅO PH√ÇN T√çCH CH·ªà S·ªê S·ª®C KH·ªéE TO√ÄN C·∫¶U"
subtitle: "Ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ WHO Global Health Observatory"
author: 
  - "Nh√≥m 3"
  - "M√¥n: Khoa H·ªçc D·ªØ Li·ªáu"
date: "2025-03-26"
output:
  word_document:
    toc: true
    toc_depth: 3
    number_sections: true
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 10,
  fig.height = 6,
  out.width = '90%'
)

library(kableExtra)
```
---


# C√†i ƒë·∫∑t v√† load c√°c package c·∫ßn thi·∫øt
```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyverse,     # Thao t√°c d·ªØ li·ªáu
  janitor,       # L√†m s·∫°ch d·ªØ li·ªáu
  httr,          # Truy v·∫•n API
  jsonlite,      # X·ª≠ l√Ω JSON
  skimr,         # Th·ªëng k√™ m√¥ t·∫£
  ggplot2,       # Tr·ª±c quan h√≥a
  patchwork,     # Gh√©p nhi·ªÅu plot
  broom,         # Tidy statistical outputs
  reshape2,      # Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu
  glue,          # N·ªëi chu·ªói
  car,           # Ki·ªÉm ƒë·ªãnh Levene
  rgho,          # Truy xu·∫•t d·ªØ li·ªáu WHO
  data.table,    # X·ª≠ l√Ω d·ªØ li·ªáu l·ªõn
  furrr          # X·ª≠ l√Ω song song
)

# C·∫•u h√¨nh x·ª≠ l√Ω song song
plan(multisession)

# √Ånh x·∫° t√™n hi·ªÉn th·ªã cho c√°c ch·ªâ s·ªë
indicator_names <- c(
  "Maternal_mortality" = "T·ª∑ l·ªá t·ª≠ vong m·∫π",
  "Under5_mortality" = "T·ª∑ l·ªá t·ª≠ vong tr·∫ª em d∆∞·ªõi 5 tu·ªïi ",
  "Infectious_disease" = "T·ª∑ l·ªá m·∫Øc c√°c b·ªánh truy·ªÅn nhi·ªÖm ",
  "Health_service" = "Ti·∫øp c·∫≠n d·ªãch v·ª• y t·∫ø "
)

# S·ª≠ d·ª•ng c√°c m√£ ch·ªâ s·ªë c·ªë ƒë·ªãnh t·ª´ WHO v·ªõi ph∆∞∆°ng √°n d·ª± ph√≤ng
indicators <- list(
  "Maternal_mortality" = c("MDG_0000000026", "MDG_0000000026"),      # Primary + backup
  "Under5_mortality" = c("MDG_0000000007", "MDG_0000000007"),        # Primary + backup
  "Infectious_disease" = c("UHC_SCL_INFECT", "SDG_03_20", "MDG_0000000017"),           # Primary + backup
  "Health_service" = c("IHRSPAR_CAPACITY09", "UHC_INDEX_REPORTED")   # Primary + backup
)
```
# 1. GI·ªöI THI·ªÜU ----

## 1.1 B·ªëi c·∫£nh nghi√™n c·ª©u ----
```{r}
cat("### 1.1 B·ªëi c·∫£nh nghi√™n c·ª©u\n")
cat("Trong b·ªëi c·∫£nh to√†n c·∫ßu h√≥a v√† s·ª± ph√°t tri·ªÉn nhanh ch√≥ng c·ªßa h·ªá th·ªëng y t·∫ø, vi·ªác ph√¢n t√≠ch c√°c ch·ªâ s·ªë s·ª©c kh·ªèe l√† v√¥ c√πng quan tr·ªçng. B√°o c√°o n√†y t·∫≠p trung v√†o vi·ªác ph√¢n t√≠ch c√°c ch·ªâ s·ªë then ch·ªët t·ª´ T·ªï Ch·ª©c Y T·∫ø Th·∫ø Gi·ªõi (WHO) nh·∫±m cung c·∫•p c√°i nh√¨n to√†n di·ªán v·ªÅ t√¨nh tr·∫°ng s·ª©c kh·ªèe to√†n c·∫ßu, ƒë·∫∑c bi·ªát t·∫≠p trung v√†o c√°c M·ª•c ti√™u Ph√°t tri·ªÉn B·ªÅn v·ªØng (SDGs) li√™n quan ƒë·∫øn y t·∫ø.\n\n")
```
## 1.2 M·ª•c ti√™u nghi√™n c·ª©u ----
```{r}
cat("### 1.2 M·ª•c ti√™u nghi√™n c·ª©u\n")
cat("C√°c m·ª•c ti√™u c·ª• th·ªÉ c·ªßa b√°o c√°o bao g·ªìm:\n\n")

objectives <- c(
  "Ph√¢n t√≠ch xu h∆∞·ªõng c√°c ch·ªâ s·ªë s·ª©c kh·ªèe quan tr·ªçng theo th·ªùi gian",
  "So s√°nh v√† ƒë√°nh gi√° s·ª± kh√°c bi·ªát gi·ªØa c√°c khu v·ª±c ƒë·ªãa l√Ω",
  "X√°c ƒë·ªãnh m·ªëi t∆∞∆°ng quan gi·ªØa c√°c ch·ªâ s·ªë s·ª©c kh·ªèe",
  "X√¢y d·ª±ng dashboard t∆∞∆°ng t√°c ƒë·ªÉ tr·ª±c quan h√≥a d·ªØ li·ªáu"
)

cat(paste("-", objectives, collapse = "\n"), "\n\n")
```
## 1.3 C√°c ch·ªâ s·ªë nghi√™n c·ª©u ----
```{r}
cat("### 1.3 C√°c ch·ªâ s·ªë nghi√™n c·ª©u\n")
cat("Nghi√™n c·ª©u t·∫≠p trung v√†o 4 nh√≥m ch·ªâ s·ªë quan tr·ªçng:\n\n")

indicators <- data.frame(
  T√™n_ch·ªâ_s·ªë = c(
    "T·ª∑ l·ªá t·ª≠ vong m·∫π",
    "T·ª∑ l·ªá t·ª≠ vong tr·∫ª em d∆∞·ªõi 5 tu·ªïi", 
    "T·ª∑ l·ªá m·∫Øc c√°c b·ªánh truy·ªÅn nhi·ªÖm: b·ªánh lao",
    "Ti·∫øp c·∫≠n d·ªãch v·ª• y t·∫ø "
  ),
  M√£_ch·ªâ_s·ªë = c(
    "Maternal Mortality Ratio",
    "Under-five Mortality Rate",
    "Infectious disease prevalence: tuberculosis",
    "Health service coverage"
  )
)

print(knitr::kable(indicators, col.names = c("T√™n ch·ªâ s·ªë", "M√£ ch·ªâ s·ªë (ti·∫øng Anh)")))
cat("\n")
```
# 2. PH∆Ø∆†NG PH√ÅP NGHI√äN C·ª®U ----

## 2.1 Ngu·ªìn d·ªØ li·ªáu ----
```{r}
cat("### 2.1 Ngu·ªìn d·ªØ li·ªáu\n")
cat("D·ªØ li·ªáu ƒë∆∞·ª£c truy xu·∫•t t·ª´ WHO Global Health Observatory (GHO) API th√¥ng qua g√≥i `rgho` trong R, bao g·ªìm c√°c ch·ªâ s·ªë SDG li√™n quan ƒë·∫øn s·ª©c kh·ªèe.\n\n")

# Code ƒë·ªÉ truy xu·∫•t d·ªØ li·ªáu t·ª´ WHO API
cat("```{r}\n")
cat("# C√†i ƒë·∫∑t g√≥i c·∫ßn thi·∫øt\n")
cat("if (!require(\"pacman\")) install.packages(\"pacman\")\n")
cat("pacman::p_load(tidyverse, rgho, httr, jsonlite, janitor)\n\n")

cat("# H√†m l·∫•y m√£ ch·ªâ s·ªë t·ª´ WHO API\n")
cat('get_who_indicator_code <- function(keyword) {\n')
cat('  url <- "https://ghoapi.azureedge.net/api/Indicator"\n')
cat('  response <- GET(url)\n')
cat('  if (status_code(response) != 200) {\n')
cat('    message("‚ùå L·ªói kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch ch·ªâ s·ªë t·ª´ WHO API")\n')
cat('    return(NULL)\n')
cat('  }\n')
cat('  data <- content(response, "text", encoding = "UTF-8") %>%\n')
cat('    fromJSON() %>%\n')
cat('    .$value\n')
cat('  result <- data %>% filter(str_detect(IndicatorName, regex(keyword, ignore_case = TRUE)))\n')
cat('  if (nrow(result) == 0) {\n')
cat('    message(paste("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ch·ªâ s·ªë n√†o ch·ª©a t·ª´ kh√≥a:", keyword))\n')
cat('    return(NULL)\n')
cat('  }\n')
cat('  return(result)\n')
cat('}\n\n')

cat("# L·∫•y m√£ c√°c ch·ªâ s·ªë nghi√™n c·ª©u\n")
cat('maternal_code <- get_who_indicator_code("maternal mortality ratio")\n')
cat('under5_code <- get_who_indicator_code("under-five mortality rate")\n')
cat('infectious_tb_code <- get_who_indicator_code("tuberculosis")\n')
cat('health_service_code <- get_who_indicator_code("health coverage")\n')

cat("# T·∫°o danh s√°ch c√°c ch·ªâ s·ªë\n")
cat('indicators <- list(\n')
cat('  "Maternal_mortality" = ifelse(!is.null(maternal_code), maternal_code$IndicatorCode[1], NA),\n')
cat('  "Under5_mortality"   = ifelse(!is.null(under5_code), under5_code$IndicatorCode[1], NA),\n')
cat('   "Infectious_tuberculosis_disease"       = ifelse(!is.null(infectious_tb_code), infectious_tb_code$IndicatorCode[1], NA),\n')
cat('  "Health_service"       = ifelse(!is.null(uhc_code), uhc_code$IndicatorCode[1], NA)\n')
cat(')\n\n')

cat('print(indicators)\n')
cat("```\n\n")
```
## 2.2 C√¥ng c·ª• ph√¢n t√≠ch ----
```{r}
cat("### 2.2 C√¥ng c·ª• ph√¢n t√≠ch\n")

tools <- data.frame(
  C√¥ng_c·ª• = c(
    "Ng√¥n ng·ªØ R v·ªõi c√°c g√≥i ch√≠nh",
    "Ph·∫ßn m·ªÅm ph√°t tri·ªÉn",
    "H·ªá th·ªëng qu·∫£n l√Ω m√£ ngu·ªìn"
  ),
  Chi_ti·∫øt = c(
    "tidyverse, rgho, ggplot2, shiny, patchwork, skimr, janitor",
    "RStudio",
    "Git v√† GitHub/GitLab"
  )
)

print(knitr::kable(tools, col.names = c("C√¥ng c·ª•", "Chi ti·∫øt")))
cat("\n")

# Code c√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt
cat("```{r}\n")
cat("# C√†i ƒë·∫∑t v√† load c√°c g√≥i c·∫ßn thi·∫øt\n")
cat('if (!require("pacman")) install.packages("pacman")\n')
cat('pacman::p_load(\n')
cat('  tidyverse,    # X·ª≠ l√Ω v√† ph√¢n t√≠ch d·ªØ li·ªáu\n')
cat('  rgho,         # Truy xu·∫•t d·ªØ li·ªáu WHO GHO\n')
cat('  ggplot2,      # Tr·ª±c quan h√≥a d·ªØ li·ªáu\n')
cat('  shiny,        # X√¢y d·ª±ng dashboard\n')
cat('  patchwork,    # K·∫øt h·ª£p nhi·ªÅu bi·ªÉu ƒë·ªì\n')
cat('  skimr,        # Th·ªëng k√™ m√¥ t·∫£\n')
cat('  janitor,      # L√†m s·∫°ch d·ªØ li·ªáu\n')
cat('  httr,         # G·ªçi API\n')
cat('  jsonlite      # X·ª≠ l√Ω JSON\n')
cat(')\n')
cat("```\n\n")

# Code kh·ªüi t·∫°o d·ª± √°n v·ªõi Git
cat("```{bash}\n")
cat("# Kh·ªüi t·∫°o repository Git\n")
cat('git init\n')
cat('git add .\n')
cat('git commit -m "Initial commit"\n')
cat("# K·∫øt n·ªëi v·ªõi remote repository (GitHub/GitLab)\n")
cat('git remote add origin <remote_repository_url>\n')
cat('git push -u origin master\n')
cat("```\n")
```
# 3. Quy tr√¨nh ph√¢n t√≠ch
## 3.1. L·∫•y d·ªØ li·ªáu t·ª´ WHO API
```{r}
# 3.1.1. H√†m l·∫•y d·ªØ li·ªáu ƒë∆∞·ª£c c·∫£i ti·∫øn
get_who_data_enhanced <- function(indicator_codes, max_retries = 3) {
  result <- NULL
  
  for (code in indicator_codes) {
    if (is.na(code)) next
    
    retry_count <- 0
    while (retry_count < max_retries && is.null(result)) {
      tryCatch({
        url <- paste0("https://ghoapi.azureedge.net/api/", code)
        response <- GET(url, timeout(30))
        
        if (status_code(response) == 200) {
          json_data <- content(response, "text", encoding = "UTF-8") %>% 
            fromJSON()
          
          if ("value" %in% names(json_data) && nrow(json_data$value) > 0) {
            result <- json_data$value %>%
              as_tibble() %>%
              clean_names() %>%
              select(
                country = spatial_dim,
                year = time_dim,
                value = numeric_value,
                region = parent_location
              ) %>%
              mutate(
                year = as.integer(year),
                value = as.numeric(value),
                indicator = code
              )
            message("‚úÖ Th√†nh c√¥ng v·ªõi m√£: ", code)
          }
        }
      }, error = function(e) {
        message("‚ùå L·ªói v·ªõi m√£ ", code, ": ", e$message)
      })
      retry_count <- retry_count + 1
      if (is.null(result)) Sys.sleep(1)
    }
    
    if (!is.null(result)) break
  }
  return(result)
}

# 3.1.2. L·∫•y d·ªØ li·ªáu song song
message("‚è≥ ƒêang l·∫•y d·ªØ li·ªáu t·ª´ WHO API...")

who_data <- future_map(names(indicators), ~{
  message("\nüì• ƒêang x·ª≠ l√Ω: ", .x)
  data <- get_who_data_enhanced(indicators[[.x]])
  
  if (!is.null(data)) {
    data %>% mutate(indicator_name = .x)
  } else {
    message("üö® Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu cho ", .x)
    NULL
  }
}, .progress = TRUE) %>% 
  set_names(names(indicators)) %>% 
  compact()

# 3.1.3. Ki·ªÉm tra v√† b√°o c√°o k·∫øt qu·∫£
message("\n==== K·∫æT QU·∫¢ T·ªîNG H·ª¢P ====")

if (length(who_data) > 0) {
  who_dt <- who_data %>% 
    map(~ as.data.table(.x)) %>% 
    rbindlist(fill = TRUE)
  
  summary_report <- who_dt[, .(
    S·ªë_b·∫£n_ghi = .N,
    NƒÉm_b·∫Øt_ƒë·∫ßu = min(year, na.rm = TRUE),
    NƒÉm_k·∫øt_th√∫c = max(year, na.rm = TRUE),
    S·ªë_qu·ªëc_gia = uniqueN(country, na.rm = TRUE),
    Gi√°_tr·ªã_TB = round(mean(value, na.rm = TRUE), 2)
  ), by = .(indicator_name)]
  
  print(kable(summary_report, 
              col.names = c("Ch·ªâ s·ªë", "S·ªë b·∫£n ghi", "NƒÉm b·∫Øt ƒë·∫ßu", 
                           "NƒÉm k·∫øt th√∫c", "S·ªë qu·ªëc gia", "Gi√° tr·ªã TB"),
              align = c("l", "r", "r", "r", "r", "r")) %>%
          kable_styling(bootstrap_options = c("striped", "hover")))
  
  # Ph·∫ßn ki·ªÉm tra d·ªØ li·ªáu thi·∫øu ƒê√É ƒê∆Ø·ª¢C S·ª¨A
  missing_indicators <- setdiff(names(indicators), names(who_data))
  if (length(missing_indicators) > 0) {
    message("\n‚ö†Ô∏è C√°c ch·ªâ s·ªë kh√¥ng c√≥ d·ªØ li·ªáu: ", paste(missing_indicators, collapse = ", "))
    
    message("\nüîç G·ª£i √Ω m√£ thay th·∫ø t·ª´ GHO:")
    gho_codes <- rgho::get_gho_codes()
    for (ind in missing_indicators) {
      message("\nT√¨m ki·∫øm m√£ cho: ", ind)
      suggested_codes <- gho_codes %>% 
        filter(str_detect(Title, regex(ind, ignore_case = TRUE))) %>% 
        head(3) %>% 
        select(Code, Title)
      
      if (nrow(suggested_codes) > 0) {
        print(suggested_codes)
      } else {
        message("Kh√¥ng t√¨m th·∫•y m√£ ph√π h·ª£p")
      }
    }
  }
} else {
  message("üö® Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu n√†o t·ª´ WHO API")
}

# 3.1.4. L∆∞u d·ªØ li·ªáu
if (length(who_data) > 0) {
  saveRDS(who_data, "who_health_data.rds")
  message("\nüíæ ƒê√£ l∆∞u d·ªØ li·ªáu v√†o file: who_health_data.rds")
}
```
# 4. Ph√¢n t√≠ch d·ªØ li·ªáu
## 4.1. Th·ªëng k√™ m√¥ t·∫£
```{r}
descriptive_stats <- map_df(who_data, ~{
  .x %>%
    group_by(indicator) %>%
    summarise(
      Mean = mean(value, na.rm = TRUE),
      SD = sd(value, na.rm = TRUE),
      Min = ifelse(all(is.na(value)), NA, min(value, na.rm = TRUE)),
      Max = ifelse(all(is.na(value)), NA, max(value, na.rm = TRUE)),
      N = n(),
      Missing = sum(is.na(value))
    ) %>%
    mutate(across(where(is.numeric), ~round(., 2)))
}, .id = "Dataset")

print(descriptive_stats)
```
## 4.2. Ph√¢n t√≠ch xu h∆∞·ªõng theo th·ªùi gian
```{r}
plot_trend <- function(df, title) {
  if (is.null(df) || nrow(df) == 0 || !"year" %in% colnames(df) || !"value" %in% colnames(df)) {
    message(paste("‚ö†Ô∏è Kh√¥ng th·ªÉ v·∫Ω bi·ªÉu ƒë·ªì cho", title, "do d·ªØ li·ªáu b·ªã thi·∫øu"))
    return(NULL)
  }
  
  df %>%
    filter(!is.na(year) & !is.na(value)) %>%
    group_by(year) %>%
    summarise(Median_Value = median(value, na.rm = TRUE), .groups = "drop") %>%
    ggplot(aes(x = year, y = Median_Value)) +
    geom_line(color = "#0072B2", linewidth = 1.2) +
    geom_point(color = "#D55E00", size = 2) +
    labs(title = paste("Xu h∆∞·ªõng", title), x = "NƒÉm", y = "Gi√° tr·ªã trung v·ªã") +
    theme_minimal()
}

trend_plots <- map2(who_data, names(who_data), ~ plot_trend(.x, indicator_names[.y]))
trend_plots <- compact(trend_plots)

if (length(trend_plots) > 0) {
  wrap_plots(trend_plots, ncol = 2) +
    plot_annotation(title = "Xu h∆∞·ªõng c√°c ch·ªâ s·ªë s·ª©c kh·ªèe theo nƒÉm",
                   theme = theme(plot.title = element_text(size = 16, face = "bold")))
}
```
## 4.3. Ph√¢n t√≠ch t∆∞∆°ng quan
```{r}
if (length(who_data) >= 2) {
  # Ph√¢n t√≠ch theo nƒÉm n·∫øu c√≥ ƒë·ªß nƒÉm chung
  common_years <- reduce(map(who_data, ~ unique(.x$year)), intersect)
  
  if (length(common_years) >= 3) {
    message("Ph√¢n t√≠ch theo nƒÉm chung (", length(common_years), " nƒÉm)")
    
    filtered_data <- map(who_data, ~ {
      .x %>% 
        filter(year %in% common_years) %>%
        group_by(year) %>%
        summarise(mean_value = mean(value, na.rm = TRUE)) %>%
        arrange(year)
    })
    
    combined <- reduce(map2(filtered_data, names(filtered_data), ~ {
      .x %>% rename(!!.y := mean_value)
    }), full_join, by = "year")
    
    numeric_data <- combined %>% 
      select(-year) %>%
      select(where(~ sum(!is.na(.x)) >= 3))  # Y√™u c·∫ßu √≠t nh·∫•t 3 quan s√°t
    
    if (ncol(numeric_data) >= 2) {
      cor_matrix <- cor(numeric_data, use = "pairwise.complete.obs")
      
      # In ma tr·∫≠n t∆∞∆°ng quan
      message("\nMa tr·∫≠n t∆∞∆°ng quan:")
      print(cor_matrix)
      
      # V·∫Ω heatmap
      melted_cor <- reshape2::melt(cor_matrix)
      
      cor_plot <- ggplot(melted_cor, aes(Var1, Var2, fill = value)) +
        geom_tile(color = "white") +
        geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
        scale_fill_gradient2(
          low = "#2b8cbe", 
          high = "#e41a1c", 
          mid = "white",
          midpoint = 0, 
          limit = c(-1, 1), 
          space = "Lab",
          name = "H·ªá s·ªë t∆∞∆°ng quan"
        ) +
        theme_minimal() +
        theme(
          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
          plot.title = element_text(face = "bold")
        ) +
        labs(
          title = "Ma tr·∫≠n t∆∞∆°ng quan gi·ªØa c√°c ch·ªâ s·ªë s·ª©c kh·ªèe",
          x = "", 
          y = ""
        )
      
      print(cor_plot)
    } else {
      message("Kh√¥ng ƒë·ªß bi·∫øn s·ªë h·ª£p l·ªá ƒë·ªÉ t√≠nh to√°n t∆∞∆°ng quan")
    }
  } else {
    message("Kh√¥ng ƒë·ªß nƒÉm chung (c·∫ßn √≠t nh·∫•t 3 nƒÉm) ƒë·ªÉ ph√¢n t√≠ch t∆∞∆°ng quan")
  }
} else {
  message("C·∫ßn √≠t nh·∫•t 2 ch·ªâ s·ªë ƒë·ªÉ ph√¢n t√≠ch t∆∞∆°ng quan")
}
```
## 4.4. So s√°nh gi·ªØa c√°c khu v·ª±c
```{r}
plot_region_comparison <- function(df, title) {
  if (!"region" %in% colnames(df)) return(NULL)
  
  df %>%
    filter(!is.na(region), region != "Unknown", !is.na(value), is.finite(value)) %>%
    ggplot(aes(x = reorder(region, value, FUN = median), y = value)) +
    geom_boxplot(fill = "#56B4E9", alpha = 0.7, outlier.shape = NA) +
    coord_flip() +
    labs(title = paste("Ph√¢n b·ªë", title, "theo khu v·ª±c"), x = NULL, y = "Gi√° tr·ªã") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12, face = "bold"))
}

region_plots <- map2(who_data, names(who_data), ~ plot_region_comparison(.x, indicator_names[.y]))
region_plots <- compact(region_plots)

if (length(region_plots) > 0) {
  wrap_plots(region_plots, ncol = 2, widths = c(1, 1.2)) +
    plot_annotation(title = "So s√°nh c√°c ch·ªâ s·ªë s·ª©c kh·ªèe theo khu v·ª±c",
                   theme = theme(plot.title = element_text(size = 16, face = "bold")))
}
```
## 4.5. Ki·ªÉm ƒë·ªãnh th·ªëng k√™
```{r}
## Ki·ªÉm ƒë·ªãnh T-Test cho Under5_mortality - PHI√äN B·∫¢N ƒê√É S·ª¨A
if ("Under5_mortality" %in% names(who_data)) {
  df_ttest <- who_data[["Under5_mortality"]] %>% 
    filter(!is.na(region), !is.na(value), region != "")
  
  valid_regions <- names(table(df_ttest$region))[table(df_ttest$region) >= 10]
  
  if (length(valid_regions) >= 2) {
    region_pairs <- combn(valid_regions, 2, simplify = FALSE)
    
    ttest_results <- map_df(region_pairs, ~ {
      df_pair <- df_ttest %>% filter(region %in% .x)
      
      if (n_distinct(df_pair$region) == 2 && all(table(df_pair$region) >= 2)) {
        test_result <- tryCatch(
          t.test(value ~ region, data = df_pair),
          error = function(e) return(NULL)
        )
        
        if (!is.null(test_result)) {
          # ƒê·∫£m b·∫£o p-value lu√¥n l√† numeric
          p_val <- ifelse(test_result$p.value < 0.001, 0.001, test_result$p.value)
          
          tibble(
            `Khu v·ª±c 1` = .x[1],
            `Khu v·ª±c 2` = .x[2],
            `Ch√™nh l·ªách TB` = round(diff(test_result$estimate), 2),
            `Gi√° tr·ªã t` = round(test_result$statistic, 2),
            `p-value` = round(p_val, 4),  # Lu√¥n l√† numeric
            `ƒê·ªô tin c·∫≠y 95%` = paste(round(test_result$conf.int, 2), collapse = " - "),
            `S·ªë quan s√°t` = paste(table(df_pair$region), collapse = " vs ")
          )
        }
      }
    })
    
    if (nrow(ttest_results) > 0) {
      # Chuy·ªÉn p-value < 0.001 th√†nh "<0.001" ch·ªâ khi hi·ªÉn th·ªã
      ttest_display <- ttest_results %>%
        mutate(`p-value` = ifelse(`p-value` == 0.001, "<0.001", as.character(round(`p-value`, 3))))
      
      knitr::kable(ttest_display, caption = "K·∫øt qu·∫£ ki·ªÉm ƒë·ªãnh T-Test gi·ªØa c√°c khu v·ª±c")
    }
  }
}

## Ph√¢n t√≠ch ANOVA cho Maternal_mortality - PHI√äN B·∫¢N ƒê√É S·ª¨A
if ("Maternal_mortality" %in% names(who_data)) {
  df_anova <- who_data[["Maternal_mortality"]] %>% 
    filter(!is.na(region), !is.na(value), region != "")
  
  region_counts <- table(df_anova$region)
  valid_regions <- names(region_counts)[region_counts >= 2]
  
  if (length(valid_regions) >= 3) {
    df_anova <- df_anova %>% filter(region %in% valid_regions)
    
    # Ki·ªÉm ƒë·ªãnh Levene
    levene_test <- tryCatch(
      leveneTest(value ~ region, data = df_anova),
      error = function(e) return(NULL)
    )
    
    if (!is.null(levene_test)) {
      cat("### Ki·ªÉm ƒë·ªãnh ph∆∞∆°ng sai ƒë·ªìng nh·∫•t (Levene's Test)\n")
      print(knitr::kable(broom::tidy(levene_test) %>%
                         mutate(p.value = ifelse(p.value < 0.001, "<0.001", round(p.value, 3)))))
      
      # Ph√¢n t√≠ch ANOVA
      anova_result <- tryCatch(
        aov(value ~ region, data = df_anova),
        error = function(e) return(NULL)
      )
      
      if (!is.null(anova_result)) {
        anova_summary <- broom::tidy(anova_result) %>%
          mutate(p.value = ifelse(p.value < 0.001, "<0.001", round(p.value, 3)))
        
        cat("\n### K·∫øt qu·∫£ ph√¢n t√≠ch ANOVA\n")
        print(knitr::kable(anova_summary))
        
        # Ki·ªÉm ƒë·ªãnh Tukey HSD n·∫øu ANOVA c√≥ √Ω nghƒ©a
        if (anova_summary$p.value[1] < 0.05) {
          tukey_result <- TukeyHSD(anova_result)
          
          cat("\n### Ki·ªÉm ƒë·ªãnh Tukey HSD\n")
          tukey_df <- broom::tidy(tukey_result) %>%
            mutate(adj.p.value = ifelse(adj.p.value < 0.001, "<0.001", round(adj.p.value, 3)))
          
          print(knitr::kable(tukey_df))
          
          # V·∫Ω bi·ªÉu ƒë·ªì Tukey
          par(mar = c(5, 12, 4, 2))
          plot(tukey_result, las = 1, cex.axis = 0.7)
        }
      }
    }
  } else {
    message("Kh√¥ng ƒë·ªß nh√≥m khu v·ª±c h·ª£p l·ªá ƒë·ªÉ th·ª±c hi·ªán ANOVA")
  }
} else {
  message("Kh√¥ng c√≥ d·ªØ li·ªáu v·ªÅ t·ª∑ l·ªá t·ª≠ vong m·∫π (Maternal_mortality)")
}
```
# 5.K·∫øt qu·∫£ v√† th·∫£o lu·∫≠n
```{r}
cat("## 3. K·∫øt qu·∫£ v√† Th·∫£o lu·∫≠n\n\n")

# T·ªïng h·ª£p k·∫øt qu·∫£
cat("### 3.1. T·ªïng quan k·∫øt qu·∫£\n")
cat("Ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ WHO v·ªõi 4 ch·ªâ s·ªë s·ª©c kh·ªèe ch√≠nh cho th·∫•y:\n\n")

if (length(who_data) > 0) {
  cat("- ƒê√£ thu th·∫≠p d·ªØ li·ªáu th√†nh c√¥ng cho", length(who_data), "ch·ªâ s·ªë s·ª©c kh·ªèe.\n")
  cat("- D·ªØ li·ªáu bao ph·ªß kho·∫£ng th·ªùi gian t·ª´", 
      min(map_dbl(who_data, ~min(.x$year, na.rm = TRUE))), "ƒë·∫øn", 
      max(map_dbl(who_data, ~max(.x$year, na.rm = TRUE))), ".\n")
  cat("- S·ªë l∆∞·ª£ng qu·ªëc gia c√≥ d·ªØ li·ªáu kh√°c nhau theo t·ª´ng ch·ªâ s·ªë:\n")
  for (indicator in names(who_data)) {
    cat("  +", indicator_names[[indicator]], ":", 
        length(unique(who_data[[indicator]]$country)), "qu·ªëc gia.\n")
  }
  cat("\n")
} else {
  cat("üö® Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c thu th·∫≠p th√†nh c√¥ng t·ª´ WHO API.\n")
}

# ƒê√°nh gi√° xu h∆∞·ªõng
cat("## 3. K·∫øt qu·∫£ v√† Th·∫£o lu·∫≠n\n\n")

# T·ªïng quan k·∫øt qu·∫£
cat("### 3.1. T·ªïng quan k·∫øt qu·∫£\n")
cat("Ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ WHO v·ªÅ b·ªën ch·ªâ s·ªë s·ª©c kh·ªèe quan tr·ªçng cung c·∫•p c√°i nh√¨n t·ªïng th·ªÉ v·ªÅ t√¨nh tr·∫°ng y t·∫ø to√†n c·∫ßu.\n")
cat("D·ªØ li·ªáu thu th·∫≠p ƒë∆∞·ª£c tr·∫£i d√†i qua nhi·ªÅu nƒÉm, gi√∫p theo d√µi xu h∆∞·ªõng s·ª©c kh·ªèe theo th·ªùi gian.\n")
cat("S·ªë l∆∞·ª£ng qu·ªëc gia c√≥ d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß kh√°c nhau t√πy v√†o t·ª´ng ch·ªâ s·ªë, ph·∫£n √°nh m·ª©c ƒë·ªô s·∫µn c√≥ v√† ƒë·ªô tin c·∫≠y c·ªßa th√¥ng tin y t·∫ø.\n\n")

# Xu h∆∞·ªõng ch√≠nh
cat("### 3.2. Xu h∆∞·ªõng ch√≠nh\n")
cat("C√°c ph√¢n t√≠ch ch·ªâ ra m·ªôt s·ªë xu h∆∞·ªõng quan tr·ªçng:\n\n")
cat("- T·ª∑ l·ªá t·ª≠ vong m·∫π v√† tr·∫ª em c√≥ xu h∆∞·ªõng gi·∫£m qua c√°c nƒÉm, ƒë·∫∑c bi·ªát t·∫°i c√°c n∆∞·ªõc c√≥ n·ªÅn y t·∫ø ph√°t tri·ªÉn.\n")
cat("- Kh·∫£ nƒÉng ti·∫øp c·∫≠n d·ªãch v·ª• y t·∫ø ƒë∆∞·ª£c c·∫£i thi·ªán ƒë√°ng k·ªÉ ·ªü nhi·ªÅu khu v·ª±c, nh∆∞ng v·∫´n c√≥ s·ª± ch√™nh l·ªách gi·ªØa c√°c qu·ªëc gia.\n")
cat("- T·ª∑ l·ªá m·∫Øc b·ªánh truy·ªÅn nhi·ªÖm gi·∫£m ·ªü m·ªôt s·ªë khu v·ª±c nh·ªù v√†o c√°c bi·ªán ph√°p ki·ªÉm so√°t d·ªãch b·ªánh v√† ti√™m ch·ªßng.\n\n")

# Khuy·∫øn ngh·ªã
cat("### 3.3. Khuy·∫øn ngh·ªã\n")
cat("1. Ti·∫øp t·ª•c theo d√µi v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu c√°c ch·ªâ s·ªë s·ª©c kh·ªèe ƒë·ªÉ ƒë√°nh gi√° hi·ªáu qu·∫£ ch√≠nh s√°ch y t·∫ø.\n")
cat("2. TƒÉng c∆∞·ªùng ƒë·∫ßu t∆∞ v√†o h·ªá th·ªëng y t·∫ø, ƒë·∫∑c bi·ªát t·∫°i c√°c qu·ªëc gia c√≥ ch·ªâ s·ªë s·ª©c kh·ªèe th·∫•p.\n")
cat("3. ƒê·∫©y m·∫°nh nghi√™n c·ª©u v·ªÅ c√°c y·∫øu t·ªë t√°c ƒë·ªông ƒë·∫øn s·ª©c kh·ªèe c·ªông ƒë·ªìng ƒë·ªÉ c√≥ bi·ªán ph√°p can thi·ªáp hi·ªáu qu·∫£ h∆°n.\n")


```